open import marking.prelude

open import marking.id
open import marking.var
open import marking.typ
open import marking.gtyp
open import marking.ctx
open import marking.multiparents

-- instrinsically typed marked expressions
module marking.mexp where
  infix  4 _âŠ¢â‡’_âˆ£_
  infix  4 _âŠ¢â‡_âˆ£_
  infix  4 _âŠ¢â‡’s_âˆ£_
  infix  4 _âŠ¢â‡s_âˆ£_

  mutual
    -- synthesis
    data _âŠ¢â‡’_âˆ£_ : (Î“ : Ctx) (Ï„ : Typ) (ğ• : MultiParents) â†’ Set where
      -- MSVar
      âŠ¢_^_ : âˆ€ {Î“ x Ï„}
        â†’ (âˆ‹x : Î“ âˆ‹ x âˆ¶ Ï„)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ Ï„ âˆ£ []

      -- MSLam
      âŠ¢Î»_âˆ¶_âˆ™_^_ : âˆ€ {Î“ Ï„' ğ•}
        â†’ (x : Var)
        â†’ (Ï„ : GTyp)
        â†’ (Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡’s Ï„' âˆ£ ğ•)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ (Ï„ â–³) -â†’ Ï„' âˆ£ ğ•

      -- MSAp1
      âŠ¢_âˆ™_[_]^_ : âˆ€ {Î“ Ï„ Ï„â‚ Ï„â‚‚ ğ•â‚ ğ•â‚‚}
        â†’ (Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚)
        â†’ (Ä›â‚‚ : Î“ âŠ¢â‡s Ï„â‚ âˆ£ ğ•â‚‚)
        â†’ (Ï„â–¸ : Ï„ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ Ï„â‚‚ âˆ£ ğ•â‚ ++ ğ•â‚‚

      -- MSAp2
      âŠ¢â¸¨_â¸©âˆ™_[_]^_ : âˆ€ {Î“ Ï„ ğ•â‚ ğ•â‚‚}
        â†’ (Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚)
        â†’ (Ä›â‚‚ : Î“ âŠ¢â‡s unknown âˆ£ ğ•â‚‚)
        â†’ (Ï„!â–¸ : Ï„ !â–¸-â†’)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ unknown âˆ£ ğ•â‚ ++ ğ•â‚‚

      -- MSNum
      âŠ¢â„•_^_ : âˆ€ {Î“}
        â†’ (n : â„•)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ num âˆ£ []

      -- MSPlus
      âŠ¢_+_^_ : âˆ€ {Î“ ğ•â‚ ğ•â‚‚}
        â†’ (Ä›â‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚)
        â†’ (Ä›â‚‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚‚)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ num âˆ£ ğ•â‚ ++ ğ•â‚‚

      -- MSFree
      âŠ¢âŸ¦_âŸ§^_ : âˆ€ {Î“ y}
        â†’ (âˆŒy : Î“ âˆŒ y)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ unknown âˆ£ []

      âŠ¢â‹^_ : âˆ€ {Î“}
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ unknown âˆ£ âˆ£[ âŸ¨ u , Î“ , Syn âŸ© ]

      âŠ¢â†»^_ : âˆ€ {Î“}
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡’ unknown âˆ£ âˆ£[ âŸ¨ u , Î“ , Syn âŸ© ]

    data _âŠ¢â‡’s_âˆ£_ : (Î“ : Ctx) (Ï„ : Typ) (ğ• : MultiParents) â†’ Set where
      -- MSubSHole: \vdash\sq^_^_
      âŠ¢â–¡^_^_ : âˆ€ {Î“}
        â†’ (w : EdgeId)
        â†’ (p : Position)
        â†’ Î“ âŠ¢â‡’s unknown âˆ£ []

      -- MSubSJust
      âŠ¢âˆ¶ : âˆ€ {Î“ Ï„Â ğ•}
        â†’ (Ä— : EdgeIdÂ Ã— Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•)
        â†’ Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•

      -- MSubSConflict: \vdash\curlywedge_
      -- TODO synthesize meet?
      âŠ¢â‹_ : âˆ€ {Î“}
        â†’ (Ä—* : List (EdgeId Ã— âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•))
        â†’ Î“ âŠ¢â‡’s unknown âˆ£ (concat (map (Î» { âŸ¨ _ , âŸ¨ _ , âŸ¨ ğ• , _ âŸ© âŸ© âŸ© â†’ ğ• }) Ä—*))

    data MSubsumable : {Î“ : Ctx} {Ï„ : Typ} {ğ• : MultiParents} â†’ (Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•) â†’ Set where
      MSuVar : âˆ€ {Î“ x u Ï„}
        â†’ {âˆ‹x : Î“ âˆ‹ x âˆ¶ Ï„}
        â†’ MSubsumable {Î“} (âŠ¢ âˆ‹x ^ u)

      MSuAp1 : âˆ€ {Î“ u Ï„ Ï„â‚ Ï„â‚‚ ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s Ï„â‚ âˆ£ ğ•â‚‚}
        â†’ {Ï„â–¸ : Ï„ â–¸ Ï„â‚ -â†’ Ï„â‚‚}
        â†’ MSubsumable {Î“} (âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u)

      MSuAp2 : âˆ€ {Î“ u Ï„ ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s unknown âˆ£ ğ•â‚‚}
        â†’ {Ï„!â–¸ : Ï„ !â–¸-â†’}
        â†’ MSubsumable {Î“} (âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u)

      MSuNum : âˆ€ {Î“ u}
        â†’ {n : â„•}
        â†’ MSubsumable {Î“} (âŠ¢â„• n ^ u)

      MSuPlus : âˆ€ {Î“ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚‚}
        â†’ MSubsumable {Î“} (âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u)

      MSuFree : âˆ€ {Î“ y u}
        â†’ {âˆŒy : Î“ âˆŒ y}
        â†’ MSubsumable {Î“} (âŠ¢âŸ¦ âˆŒy âŸ§^ u)

      MSuMultiParent : âˆ€ {Î“ u}
        â†’ MSubsumable {Î“} (âŠ¢â‹^ u)

      MSuUnicycle : âˆ€ {Î“ u}
        â†’ MSubsumable {Î“} (âŠ¢â†»^ u)

    -- analysis
    data _âŠ¢â‡_âˆ£_ : (Î“ : Ctx) (Ï„ : Typ) (ğ• : MultiParents) â†’ Set where
      -- MALam1
      âŠ¢Î»_âˆ¶_âˆ™_[_âˆ™_]^_ : âˆ€ {Î“ Ï„â‚ Ï„â‚‚ Ï„â‚ƒ ğ•}
        â†’ (x : Var)
        â†’ (Ï„ : GTyp)
        â†’ (Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚ âˆ£ ğ•)
        â†’ (Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (Ï„~Ï„â‚ : (Ï„ â–³) ~ Ï„â‚)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡ Ï„â‚ƒ âˆ£ ğ•

      -- MALam2
      âŠ¢â¸¨Î»_âˆ¶_âˆ™_â¸©[_]^_ : âˆ€ {Î“ Ï„' ğ•}
        â†’ (x : Var)
        â†’ (Ï„ : GTyp)
        â†’ (Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s unknown âˆ£ ğ•)
        â†’ (Ï„'!â–¸ : Ï„' !â–¸-â†’)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡ Ï„' âˆ£ ğ•

      -- MALam3
      âŠ¢Î»_âˆ¶â¸¨_â¸©âˆ™_[_âˆ™_]^_ : âˆ€ {Î“ Ï„â‚ Ï„â‚‚ Ï„â‚ƒÂ ğ•}
        â†’ (x : Var)
        â†’ (Ï„ : GTyp)
        â†’ (Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚ âˆ£ ğ•)
        â†’ (Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (Ï„~Ì¸Ï„â‚ : (Ï„ â–³) ~Ì¸ Ï„â‚)
        â†’ (u : VertexId)
        â†’ Î“ âŠ¢â‡ Ï„â‚ƒ âˆ£ ğ•

      -- MAInconsistentTypes
      âŠ¢â¸¨_â¸©[_âˆ™_] : âˆ€ {Î“ Ï„ Ï„' ğ•}
        â†’ (Ä› : Î“ âŠ¢â‡’ Ï„' âˆ£ ğ•)
        â†’ (Ï„~Ì¸Ï„' : Ï„ ~Ì¸ Ï„')
        â†’ (su : MSubsumable Ä›)
        â†’ Î“ âŠ¢â‡ Ï„ âˆ£ ğ•

      -- MASubsume
      âŠ¢âˆ™_[_âˆ™_] : âˆ€ {Î“ Ï„ Ï„' ğ•}
        â†’ (Ä› : Î“ âŠ¢â‡’ Ï„' âˆ£ ğ•)
        â†’ (Ï„~Ï„' : Ï„ ~ Ï„')
        â†’ (su : MSubsumable Ä›)
        â†’ Î“ âŠ¢â‡ Ï„ âˆ£ ğ•

    data _âŠ¢â‡s_âˆ£_ : (Î“ : Ctx) (Ï„ : Typ) (ğ• : MultiParents) â†’ Set where
      -- MSubASubsume
      âŠ¢âˆ™_[_] : âˆ€ {Î“ Ï„ Ï„' ğ•}
        â†’ (Ä› : Î“ âŠ¢â‡’s Ï„' âˆ£ ğ•)
        â†’ (Ï„~Ï„' : Ï„ ~ Ï„')
        â†’ Î“ âŠ¢â‡s Ï„ âˆ£ ğ•

      -- MSubAInconsistentTypes
      âŠ¢â¸¨_â¸©[_] : âˆ€ {Î“ Ï„ Ï„' ğ•}
        â†’ (Ä› : Î“ âŠ¢â‡’s Ï„' âˆ£ ğ•)
        â†’ (Ï„~Ì¸Ï„' : Ï„ ~Ì¸ Ï„')
        â†’ Î“ âŠ¢â‡s Ï„ âˆ£ ğ•

  mutual
    data Marklessâ‡’ : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•) â†’ Set where
      MLSVar : âˆ€ {Î“ x u Ï„}
        â†’ {âˆ‹x : Î“ âˆ‹ x âˆ¶ Ï„}
        â†’ Marklessâ‡’ {Î“} (âŠ¢ âˆ‹x ^ u)

      MLSLam : âˆ€ {Î“ Ï„' x Ï„ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡’s Ï„' âˆ£ ğ•}
        â†’ (less : Marklessâ‡’s Ä›)
        â†’ Marklessâ‡’ {Î“} (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› ^ u)

      MLSAp : âˆ€ {Î“ Ï„ Ï„â‚ Ï„â‚‚ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s Ï„â‚ âˆ£ ğ•â‚‚}
        â†’ {Ï„â–¸ : Ï„ â–¸ Ï„â‚ -â†’ Ï„â‚‚}
        â†’ (lessâ‚ : Marklessâ‡’s Ä›â‚)
        â†’ (lessâ‚‚ : Marklessâ‡s Ä›â‚‚)
        â†’ Marklessâ‡’ {Î“} (âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u)

      MLSNum : âˆ€ {Î“ n u}
        â†’ Marklessâ‡’ {Î“} (âŠ¢â„• n ^ u)

      MLSPlus : âˆ€ {Î“ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚‚}
        â†’ (lessâ‚ : Marklessâ‡s Ä›â‚)
        â†’ (lessâ‚‚ : Marklessâ‡s Ä›â‚‚)
        â†’ Marklessâ‡’ {Î“} (âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u)

      MLSMultiParent : âˆ€ {Î“ u}
        â†’ Marklessâ‡’ {Î“} (âŠ¢â‹^ u)

      MLSUnicycle : âˆ€ {Î“ u}
        â†’ Marklessâ‡’ {Î“} (âŠ¢â†»^ u)

    data Marklessâ‡’s : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•) â†’ Set where
      MLSubSHole : âˆ€ {Î“ w p}
        â†’ Marklessâ‡’s {Î“} (âŠ¢â–¡^ w ^ p)

      MLSubSJust : âˆ€ {Î“ w Ï„ ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•}
        â†’ (less : Marklessâ‡’ Ä›)
        â†’ Marklessâ‡’s {Î“} (âŠ¢âˆ¶ âŸ¨ w , Ä› âŸ©)

      -- TODO maybe this is a mark?
      MLSubSConflict : âˆ€ {Î“}
        â†’ {Ä—* : List (EdgeId Ã— âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•)}
        â†’ (less* : All (Î» { âŸ¨ _ , âŸ¨ _ , âŸ¨ _ , Ä› âŸ© âŸ© âŸ© â†’ Marklessâ‡’ Ä› }) Ä—*)
        â†’ Marklessâ‡’s {Î“} (âŠ¢â‹ Ä—*)

    data Marklessâ‡ : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡ Ï„ âˆ£ ğ•) â†’ Set where
      MLALam : âˆ€ {Î“ Ï„â‚ Ï„â‚‚ Ï„â‚ƒ x Ï„ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚ âˆ£ ğ•}
        â†’ {Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚}
        â†’ {Ï„~Ï„â‚ : (Ï„ â–³) ~ Ï„â‚}
        â†’ (less : Marklessâ‡s Ä›)
        â†’ Marklessâ‡ {Î“} (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ï„â‚ ]^ u)

      MLASubsume : âˆ€ {Î“ Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„' âˆ£ ğ•}
        â†’ {Ï„~Ï„' : Ï„ ~ Ï„'}
        â†’ {su : MSubsumable Ä›}
        â†’ (less : Marklessâ‡’ Ä›)
        â†’ Marklessâ‡ {Î“} (âŠ¢âˆ™ Ä› [ Ï„~Ï„' âˆ™ su ])

    data Marklessâ‡s : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡s Ï„ âˆ£ ğ•) â†’ Set where
      MLSubASubsume : âˆ€ {Î“ Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’s Ï„' âˆ£ ğ•}
        â†’ {Ï„~Ï„' : Ï„ ~ Ï„'}
        â†’ (less : Marklessâ‡’s Ä›)
        â†’ Marklessâ‡s {Î“} (âŠ¢âˆ™ Ä› [ Ï„~Ï„' ])
