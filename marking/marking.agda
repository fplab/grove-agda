open import marking.prelude
open import marking.id
open import marking.typ
open import marking.gtyp
open import marking.ctx
open import marking.multiparents
open import marking.uexp
open import marking.mexp

module marking.marking where
  infix 4 _âŠ¢_â†¬â‡’_
  infix 4 _âŠ¢_â†¬â‡_
  infix 4 _âŠ¢s_â†¬â‡’_
  infix 4 _âŠ¢s_â†¬â‡_

  -- mark insertion
  mutual
    -- synthesis
    data _âŠ¢_â†¬â‡’_ : {Ï„ : Typ} {ğ• : MultiParents} (Î“ : Ctx) â†’ (e : UExp) â†’ (Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•) â†’ Set where
      MKSVar : âˆ€ {Î“ x Ï„ u}
        â†’ (âˆ‹x : Î“ âˆ‹ x âˆ¶ Ï„)
        â†’ Î“ âŠ¢ - x ^ u â†¬â‡’ âŠ¢ âˆ‹x ^ u

      MKSFree : âˆ€ {Î“ y u}
        â†’ (âˆŒy : Î“ âˆŒ y)
        â†’ Î“ âŠ¢ - y ^ u â†¬â‡’ âŠ¢âŸ¦ âˆŒy âŸ§^ u

      MKSLam : âˆ€ {Î“ x Ï„ e Ï„â‚ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡’s Ï„â‚ âˆ£ ğ•}
        â†’ (eâ†¬â‡’Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡’ Ä›)
        â†’ Î“ âŠ¢ -Î» x âˆ¶ Ï„ âˆ™ e ^ u â†¬â‡’ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› ^ u

      MKSAp1 : âˆ€ {Î“ eâ‚ eâ‚‚ Ï„ Ï„â‚ Ï„â‚‚ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s Ï„â‚ âˆ£ ğ•â‚‚}
        â†’ (eâ‚â†¬â‡’Ä›â‚ : Î“ âŠ¢s eâ‚ â†¬â‡’ Ä›â‚)
        â†’ (Ï„â–¸ : Ï„ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (eâ‚‚â†¬â‡Ä›â‚‚ : Î“ âŠ¢s eâ‚‚ â†¬â‡ Ä›â‚‚)
        â†’ Î“ âŠ¢ - eâ‚ âˆ™ eâ‚‚ ^ u â†¬â‡’ âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u

      MKSAp2 : âˆ€ {Î“ eâ‚ eâ‚‚ Ï„ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•â‚}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s unknown âˆ£ ğ•â‚‚}
        â†’ (eâ‚â†¬â‡’Ä›â‚ : Î“ âŠ¢s eâ‚ â†¬â‡’ Ä›â‚)
        â†’ (Ï„!â–¸ : Ï„ !â–¸-â†’)
        â†’ (eâ‚‚â†¬â‡Ä›â‚‚ : Î“ âŠ¢s eâ‚‚ â†¬â‡ Ä›â‚‚)
        â†’ Î“ âŠ¢ - eâ‚ âˆ™ eâ‚‚ ^ u â†¬â‡’ âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u

      MKSNum : âˆ€ {Î“ n u}
        â†’ Î“ âŠ¢ -â„• n ^ u â†¬â‡’ âŠ¢â„• n ^ u

      MKSPlus : âˆ€ {Î“ eâ‚ eâ‚‚ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚}  
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s num âˆ£ ğ•â‚‚}
        â†’ (eâ‚â†¬â‡Ä›â‚ : Î“ âŠ¢s eâ‚ â†¬â‡ Ä›â‚)
        â†’ (eâ‚‚â†¬â‡Ä›â‚‚ : Î“ âŠ¢s eâ‚‚ â†¬â‡ Ä›â‚‚)
        â†’ Î“ âŠ¢ - eâ‚ + eâ‚‚ ^ u â†¬â‡’ âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u

      MKSMultiParent : âˆ€ {Î“ u}
        â†’ Î“ âŠ¢ -â‹^ u â†¬â‡’ âŠ¢â‹^ u

      MKSUnicycle : âˆ€ {Î“ u}
        â†’ Î“ âŠ¢ -â†»^ u â†¬â‡’ âŠ¢â†»^ u

    MKSubSConflictChildren : âˆ€ {Î“} {Ä—* : List USubExp'}
      â†’ (Ä—â†¬â‡’Ä›* : All (Î» (âŸ¨ _ , e âŸ©) â†’ âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ âˆ£ ğ• ] Î“ âŠ¢ e â†¬â‡’ Ä›) Ä—*)
      â†’ List (EdgeId Ã— âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•)
    MKSubSConflictChildren [] = []
    MKSubSConflictChildren (_âˆ·_ {âŸ¨ w , _ âŸ©} âŸ¨ Ï„ , âŸ¨ ğ• , âŸ¨ Ä› , _ âŸ© âŸ© âŸ© Ä—â†¬â‡’Ä›*) = âŸ¨ w , âŸ¨ Ï„ , âŸ¨ ğ• , Ä› âŸ© âŸ© âŸ© âˆ· (MKSubSConflictChildren Ä—â†¬â‡’Ä›*)

    data _âŠ¢s_â†¬â‡’_ : {Ï„ : Typ} {ğ• : MultiParents} (Î“ : Ctx) â†’ (e : USubExp) â†’ (Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•) â†’ Set where
      MKSubSHole : âˆ€ {Î“ w p}
        â†’ Î“ âŠ¢s -â–¡^ w ^ p â†¬â‡’ âŠ¢â–¡^ w ^ p

      MKSubSJust : âˆ€ {Î“ w e Ï„ ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•} 
        â†’ (eâ†¬â‡’Ä› : Î“  âŠ¢ e â†¬â‡’ Ä›)
        â†’ Î“ âŠ¢s -âˆ¶ âŸ¨ w , e âŸ© â†¬â‡’ âŠ¢âˆ¶ âŸ¨ w , Ä› âŸ©

      MKSubSConflict : âˆ€ {Î“ Ä—*}
        â†’ (Ä—â†¬â‡’Ä›* : All (Î» (âŸ¨ _ , e âŸ©) â†’ âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ âˆ£ ğ• ] Î“ âŠ¢ e â†¬â‡’ Ä›) Ä—*)
        â†’ Î“ âŠ¢s -â‹ Ä—* â†¬â‡’ âŠ¢â‹ (MKSubSConflictChildren Ä—â†¬â‡’Ä›*)

    USuâ†’MSu : âˆ€ {e : UExp} {Î“ : Ctx} {Ï„ : Typ} {ğ• : MultiParents} {Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•} â†’ USubsumable e â†’ Î“ âŠ¢ e â†¬â‡’ Ä› â†’ MSubsumable Ä›
    USuâ†’MSu {Ä› = âŠ¢_^_ {x = x} âˆ‹x u}      USuVar          _ = MSuVar
    USuâ†’MSu {Ä› = âŠ¢âŸ¦ x âŸ§^ u}              USuVar          _ = MSuFree
    USuâ†’MSu {Ä› = âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u}    USuAp           _ = MSuAp1
    USuâ†’MSu {Ä› = âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u} USuAp           _ = MSuAp2
    USuâ†’MSu {Ä› = âŠ¢â„• n ^ u}               USuNum          _ = MSuNum
    USuâ†’MSu {Ä› = âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u}          USuPlus         _ = MSuPlus
    USuâ†’MSu {Ä› = âŠ¢â‹^ u}                  USuMultiParent  _ = MSuMultiParent
    USuâ†’MSu {Ä› = âŠ¢â†»^ u}                  USuUnicycle     _ = MSuUnicycle

    -- analysis
    data _âŠ¢_â†¬â‡_ : {Ï„ : Typ} {ğ• : MultiParents} (Î“ : Ctx) â†’ (e : UExp) â†’ (Î“ âŠ¢â‡ Ï„ âˆ£ ğ•) â†’ Set where
      MKALam1 : âˆ€ {Î“ x Ï„ e Ï„â‚ Ï„â‚‚ Ï„â‚ƒ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚ âˆ£ ğ•}
        â†’ (Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (Ï„~Ï„â‚ : (Ï„ â–³) ~ Ï„â‚)
        â†’ (eâ†¬â‡Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡ Ä›)
        â†’ Î“ âŠ¢ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u) â†¬â‡ (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ï„â‚ ]^ u)

      MKALam2 : âˆ€ {Î“ x Ï„ e Ï„' u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s unknown âˆ£ ğ•}
        â†’ (Ï„'!â–¸ : Ï„' !â–¸-â†’)
        â†’ (eâ†¬â‡Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡ Ä›)
        â†’ Î“ âŠ¢ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u) â†¬â‡ (âŠ¢â¸¨Î» x âˆ¶ Ï„ âˆ™ Ä› â¸©[ Ï„'!â–¸ ]^ u)

      MKALam3 : âˆ€ {Î“ x Ï„ e Ï„â‚ Ï„â‚‚ Ï„â‚ƒ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚ âˆ£ ğ•}
        â†’ (Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (Ï„~Ì¸Ï„â‚ : (Ï„ â–³) ~Ì¸ Ï„â‚)
        â†’ (eâ†¬â‡Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡ Ä›)
        â†’ Î“ âŠ¢ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u) â†¬â‡ (âŠ¢Î» x âˆ¶â¸¨ Ï„ â¸©âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ì¸Ï„â‚ ]^ u)

      MKASubsume : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„' âˆ£ ğ•}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢ e â†¬â‡’ Ä›)
        â†’ (Ï„~Ï„' : Ï„ ~ Ï„')
        â†’ (s : USubsumable e)
        â†’ Î“ âŠ¢ e â†¬â‡ âŠ¢âˆ™ Ä› [ Ï„~Ï„' âˆ™ USuâ†’MSu s eâ†¬â‡’Ä› ]

      MKAInconsistentTypes : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„' âˆ£ ğ•}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢ e â†¬â‡’ Ä›)
        â†’ (Ï„~Ì¸Ï„' : Ï„ ~Ì¸ Ï„')
        â†’ (s : USubsumable e)
        â†’ Î“ âŠ¢ e â†¬â‡ âŠ¢â¸¨ Ä› â¸©[ Ï„~Ì¸Ï„' âˆ™ USuâ†’MSu s eâ†¬â‡’Ä› ]

    data _âŠ¢s_â†¬â‡_ : {Ï„ : Typ} {ğ• : MultiParents} (Î“ : Ctx) â†’ (e : USubExp) â†’ (Î“ âŠ¢â‡s Ï„ âˆ£ ğ•) â†’ Set where
      MKSubASubsume : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’s Ï„' âˆ£ ğ•}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢s e â†¬â‡’ Ä› )
        â†’ (Ï„~Ï„' : Ï„ ~ Ï„')
        â†’ Î“ âŠ¢s e â†¬â‡ âŠ¢âˆ™ Ä› [ Ï„~Ï„' ]

      MKSubAInconsistentTypes : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’s Ï„' âˆ£ ğ•}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢s e â†¬â‡’ Ä›)
        â†’ (Ï„~Ì¸Ï„' : Ï„ ~Ì¸ Ï„')
        â†’ Î“ âŠ¢s e â†¬â‡ âŠ¢â¸¨ Ä› â¸©[ Ï„~Ì¸Ï„' ]
