open import marking.prelude
open import marking.id
open import marking.typ
open import marking.gtyp
open import marking.ctx
open import marking.multiparents
open import marking.uexp
open import marking.mexp

module marking.marking where
  infix 4 _âŠ¢_â†¬â‡’_âˆ£_
  infix 4 _âŠ¢_â†¬â‡_âˆ£_
  infix 4 _âŠ¢s_â†¬â‡’_âˆ£_
  infix 4 _âŠ¢s_â†¬â‡_âˆ£_

  -- mark insertion
  mutual
    -- synthesis
    data _âŠ¢_â†¬â‡’_âˆ£_ : {Ï„ : Typ} (Î“ : Ctx) â†’ (e : UExp) â†’ (Î“ âŠ¢â‡’ Ï„) â†’ (ğ• : MultiParents) â†’ Set where
      MKSVar : âˆ€ {Î“ x Ï„ u}
        â†’ (âˆ‹x : Î“ âˆ‹ x âˆ¶ Ï„)
        â†’ Î“ âŠ¢ - x ^ u â†¬â‡’ âŠ¢ âˆ‹x ^ u âˆ£ []

      MKSFree : âˆ€ {Î“ y u}
        â†’ (âˆŒy : Î“ âˆŒ y)
        â†’ Î“ âŠ¢ - y ^ u â†¬â‡’ âŠ¢âŸ¦ âˆŒy âŸ§^ u âˆ£ []

      MKSLam : âˆ€ {Î“ x Ï„ e Ï„â‚ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡’s Ï„â‚}
        â†’ (eâ†¬â‡’Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡’ Ä› âˆ£ ğ•)
        â†’ Î“ âŠ¢ -Î» x âˆ¶ Ï„ âˆ™ e ^ u â†¬â‡’ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› ^ u âˆ£ ğ•

      MKSAp1 : âˆ€ {Î“ eâ‚ eâ‚‚ Ï„ Ï„â‚ Ï„â‚‚ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s Ï„â‚}
        â†’ (eâ‚â†¬â‡’Ä›â‚ : Î“ âŠ¢s eâ‚ â†¬â‡’ Ä›â‚ âˆ£ ğ•â‚)
        â†’ (Ï„â–¸ : Ï„ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (eâ‚‚â†¬â‡Ä›â‚‚ : Î“ âŠ¢s eâ‚‚ â†¬â‡ Ä›â‚‚ âˆ£ ğ•â‚‚)
        â†’ Î“ âŠ¢ - eâ‚ âˆ™ eâ‚‚ ^ u â†¬â‡’ âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u âˆ£ ğ•â‚ ++ ğ•â‚‚

      MKSAp2 : âˆ€ {Î“ eâ‚ eâ‚‚ Ï„ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡’s Ï„}
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s unknown}
        â†’ (eâ‚â†¬â‡’Ä›â‚ : Î“ âŠ¢s eâ‚ â†¬â‡’ Ä›â‚ âˆ£ ğ•â‚)
        â†’ (Ï„!â–¸ : Ï„ !â–¸-â†’)
        â†’ (eâ‚‚â†¬â‡Ä›â‚‚ : Î“ âŠ¢s eâ‚‚ â†¬â‡ Ä›â‚‚ âˆ£ ğ•â‚‚)
        â†’ Î“ âŠ¢ - eâ‚ âˆ™ eâ‚‚ ^ u â†¬â‡’ âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u âˆ£ ğ•â‚ ++ ğ•â‚‚

      MKSNum : âˆ€ {Î“ n u}
        â†’ Î“ âŠ¢ -â„• n ^ u â†¬â‡’ âŠ¢â„• n ^ u âˆ£ []

      MKSPlus : âˆ€ {Î“ eâ‚ eâ‚‚ u ğ•â‚ ğ•â‚‚}
        â†’ {Ä›â‚ : Î“ âŠ¢â‡s num}  
        â†’ {Ä›â‚‚ : Î“ âŠ¢â‡s num}
        â†’ (eâ‚â†¬â‡Ä›â‚ : Î“ âŠ¢s eâ‚ â†¬â‡ Ä›â‚ âˆ£ ğ•â‚)
        â†’ (eâ‚‚â†¬â‡Ä›â‚‚ : Î“ âŠ¢s eâ‚‚ â†¬â‡ Ä›â‚‚ âˆ£ ğ•â‚‚)
        â†’ Î“ âŠ¢ - eâ‚ + eâ‚‚ ^ u â†¬â‡’ âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u âˆ£ ğ•â‚ ++ ğ•â‚‚

      MKSMultiParent : âˆ€ {Î“ u}
        â†’ Î“ âŠ¢ -â‹^ u â†¬â‡’ âŠ¢â‹^ u âˆ£ âˆ£[ âŸ¨ u , Î“ , Syn âŸ© ]

      MKSUnicycle : âˆ€ {Î“ u}
        â†’ Î“ âŠ¢ -â†»^ u â†¬â‡’ âŠ¢â†»^ u âˆ£ âˆ£[ âŸ¨ u , Î“ , Syn âŸ© ]

    MKSubSConflictChildren : âˆ€ {Î“} {Ä—* : List USubExp'}
      â†’ (Ä—â†¬â‡’Ä›* : All (Î» (âŸ¨ _ , e âŸ©) â†’ âˆƒ[ Ï„ ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ•) Ä—*)
      â†’ List (EdgeId Ã— âˆƒ[ Ï„ ] Î“ âŠ¢â‡’ Ï„)
    MKSubSConflictChildren [] = []
    MKSubSConflictChildren (_âˆ·_ {âŸ¨ w , _ âŸ©} âŸ¨ Ï„ , âŸ¨ Ä› , _ âŸ© âŸ© Ä—â†¬â‡’Ä›*) = âŸ¨ w , âŸ¨ Ï„ , Ä› âŸ© âŸ© âˆ· (MKSubSConflictChildren Ä—â†¬â‡’Ä›*)

    MKSubSConflictMultiParents : âˆ€ {Î“} {Ä—* : List USubExp'}
      â†’ (Ä—â†¬â‡’Ä›* : All (Î» (âŸ¨ _ , e âŸ©) â†’ âˆƒ[ Ï„ ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ•) Ä—*)
      â†’ MultiParents
    MKSubSConflictMultiParents [] = []
    MKSubSConflictMultiParents (âŸ¨ _ , âŸ¨ _ , âŸ¨ ğ• , _ âŸ© âŸ© âŸ© âˆ· Ä—â†¬â‡’Ä›*) = ğ• ++ MKSubSConflictMultiParents Ä—â†¬â‡’Ä›*

    data _âŠ¢s_â†¬â‡’_âˆ£_ : {Ï„ : Typ} (Î“ : Ctx) â†’ (e : USubExp) â†’ (Î“ âŠ¢â‡’s Ï„) â†’ (ğ• : MultiParents) â†’ Set where
      MKSubSHole : âˆ€ {Î“ w p}
        â†’ Î“ âŠ¢s -â–¡^ w ^ p â†¬â‡’ âŠ¢â–¡^ w ^ p âˆ£ []

      MKSubSJust : âˆ€ {Î“ w e Ï„ ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„} 
        â†’ (eâ†¬â‡’Ä› : Î“  âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ•)
        â†’ Î“ âŠ¢s -âˆ¶ âŸ¨ w , e âŸ© â†¬â‡’ âŠ¢âˆ¶ âŸ¨ w , Ä› âŸ© âˆ£ ğ•

      MKSubSConflict : âˆ€ {Î“ Ä—*}
        â†’ (Ä—â†¬â‡’Ä›* : All (Î» (âŸ¨ _ , e âŸ©) â†’ âˆƒ[ Ï„ ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ•) Ä—*)
        â†’ Î“ âŠ¢s -â‹ Ä—* â†¬â‡’ âŠ¢â‹ (MKSubSConflictChildren Ä—â†¬â‡’Ä›*) âˆ£ (MKSubSConflictMultiParents Ä—â†¬â‡’Ä›*)

    USuâ†’MSu : âˆ€ {e : UExp} {Î“ : Ctx} {Ï„ : Typ} {Ä› : Î“ âŠ¢â‡’ Ï„} {ğ• : MultiParents} â†’ USubsumable e â†’ Î“ âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ• â†’ MSubsumable Ä›
    USuâ†’MSu {Ä› = âŠ¢_^_ {x = x} âˆ‹x u}      USuVar          _ = MSuVar
    USuâ†’MSu {Ä› = âŠ¢âŸ¦ x âŸ§^ u}              USuVar          _ = MSuFree
    USuâ†’MSu {Ä› = âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u}    USuAp           _ = MSuAp1
    USuâ†’MSu {Ä› = âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u} USuAp           _ = MSuAp2
    USuâ†’MSu {Ä› = âŠ¢â„• n ^ u}               USuNum          _ = MSuNum
    USuâ†’MSu {Ä› = âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u}          USuPlus         _ = MSuPlus
    USuâ†’MSu {Ä› = âŠ¢â‹^ u}                  USuMultiParent  _ = MSuMultiParent
    USuâ†’MSu {Ä› = âŠ¢â†»^ u}                  USuUnicycle     _ = MSuUnicycle

    -- analysis
    data _âŠ¢_â†¬â‡_âˆ£_ : {Ï„ : Typ} (Î“ : Ctx) â†’ (e : UExp) â†’ (Î“ âŠ¢â‡ Ï„) â†’ (ğ• : MultiParents) â†’ Set where
      MKALam1 : âˆ€ {Î“ x Ï„ e Ï„â‚ Ï„â‚‚ Ï„â‚ƒ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚}
        â†’ (Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (Ï„~Ï„â‚ : (Ï„ â–³) ~ Ï„â‚)
        â†’ Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡ Ä› âˆ£ ğ•
        â†’ Î“ âŠ¢ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u) â†¬â‡ (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ï„â‚ ]^ u) âˆ£ ğ•

      MKALam2 : âˆ€ {Î“ x Ï„ e Ï„' u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s unknown}
        â†’ (Ï„'!â–¸ : Ï„' !â–¸-â†’)
        â†’ Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡ Ä› âˆ£ ğ•
        â†’ Î“ âŠ¢ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u) â†¬â‡ (âŠ¢â¸¨Î» x âˆ¶ Ï„ âˆ™ Ä› â¸©[ Ï„'!â–¸ ]^ u) âˆ£ ğ•

      MKALam3 : âˆ€ {Î“ x Ï„ e Ï„â‚ Ï„â‚‚ Ï„â‚ƒ u ğ•}
        â†’ {Ä› : Î“ , x âˆ¶ (Ï„ â–³) âŠ¢â‡s Ï„â‚‚}
        â†’ (Ï„â‚ƒâ–¸ : Ï„â‚ƒ â–¸ Ï„â‚ -â†’ Ï„â‚‚)
        â†’ (Ï„~Ì¸Ï„â‚ : (Ï„ â–³) ~Ì¸ Ï„â‚)
        â†’ Î“ , x âˆ¶ (Ï„ â–³) âŠ¢s e â†¬â‡ Ä› âˆ£ ğ•
        â†’ Î“ âŠ¢ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u) â†¬â‡ (âŠ¢Î» x âˆ¶â¸¨ Ï„ â¸©âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ì¸Ï„â‚ ]^ u) âˆ£ ğ•

      MKASubsume : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„'}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ•)
        â†’ (Ï„~Ï„' : Ï„ ~ Ï„')
        â†’ (s : USubsumable e)
        â†’ Î“ âŠ¢ e â†¬â‡ âŠ¢âˆ™ Ä› [ Ï„~Ï„' âˆ™ USuâ†’MSu s eâ†¬â‡’Ä› ] âˆ£ ğ•

      MKAInconsistentTypes : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’ Ï„'}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢ e â†¬â‡’ Ä› âˆ£ ğ•)
        â†’ (Ï„~Ì¸Ï„' : Ï„ ~Ì¸ Ï„')
        â†’ (s : USubsumable e)
        â†’ Î“ âŠ¢ e â†¬â‡ âŠ¢â¸¨ Ä› â¸©[ Ï„~Ì¸Ï„' âˆ™ USuâ†’MSu s eâ†¬â‡’Ä› ] âˆ£ ğ•

    data _âŠ¢s_â†¬â‡_âˆ£_ : {Ï„ : Typ} (Î“ : Ctx) â†’ (e : USubExp) â†’ (Î“ âŠ¢â‡s Ï„) â†’ (ğ• : MultiParents) â†’ Set where
      MKSubASubsume : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’s Ï„'}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢s e â†¬â‡’ Ä› âˆ£ ğ•)
        â†’ (Ï„~Ï„' : Ï„ ~ Ï„')
        â†’ Î“ âŠ¢s e â†¬â‡ âŠ¢âˆ™ Ä› [ Ï„~Ï„' ] âˆ£ ğ•

      MKSubAInconsistentTypes : âˆ€ {Î“ e Ï„ Ï„' ğ•}
        â†’ {Ä› : Î“ âŠ¢â‡’s Ï„'}
        â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢s e â†¬â‡’ Ä› âˆ£ ğ•)
        â†’ (Ï„~Ì¸Ï„' : Ï„ ~Ì¸ Ï„')
        â†’ Î“ âŠ¢s e â†¬â‡ âŠ¢â¸¨ Ä› â¸©[ Ï„~Ì¸Ï„' ] âˆ£ ğ•
