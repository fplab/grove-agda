open import marking.prelude

open import marking.id
open import marking.typ
open import marking.gtyp
open import marking.uexp
open import marking.mexp

module marking.erasure where
  mutual
    _â‡’â–¡ : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•) â†’ UExp
    (âŠ¢_^_ {x = x} âˆ‹x u)      â‡’â–¡ = - x ^ u
    (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› ^ u)       â‡’â–¡ = -Î» x âˆ¶ Ï„ âˆ™ (Ä› â‡’â–¡s) ^ u
    (âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u)    â‡’â–¡ = - (Ä›â‚ â‡’â–¡s) âˆ™ (Ä›â‚‚ â‡â–¡s) ^ u
    (âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u) â‡’â–¡ = - (Ä›â‚ â‡’â–¡s) âˆ™ (Ä›â‚‚ â‡â–¡s) ^ u
    (âŠ¢â„• n ^ u)               â‡’â–¡ = -â„• n ^ u
    (âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u)          â‡’â–¡ = - (Ä›â‚ â‡â–¡s) + (Ä›â‚‚ â‡â–¡s) ^ u
    (âŠ¢âŸ¦_âŸ§^_ {y = y} âˆŒy u)    â‡’â–¡ = - y ^ u
    (âŠ¢â‹^ u)                  â‡’â–¡ = -â‹^ u
    (âŠ¢â†»^ u)                  â‡’â–¡ = -â†»^ u

    _â‡’â–¡s : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•) â†’ USubExp
    (âŠ¢â–¡^ w ^ p)    â‡’â–¡s = -â–¡^ w ^ p
    (âŠ¢âˆ¶ âŸ¨ w , Ä› âŸ©) â‡’â–¡s = -âˆ¶ (âŸ¨ w , Ä› â‡’â–¡ âŸ©)
    (âŠ¢â‹ Ä—*)        â‡’â–¡s = -â‹ (Ä—* â‡’â–¡s*)

    _â‡’â–¡s* : âˆ€ {Î“} â†’ (Ä—* : List (EdgeId Ã— âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•)) â†’ List USubExp'
    []                       â‡’â–¡s* = []
    (âŸ¨ w , âŸ¨ _ , âŸ¨ _ , Ä› âŸ© âŸ© âŸ© âˆ· Ä—*) â‡’â–¡s* = âŸ¨ w , Ä› â‡’â–¡ âŸ© âˆ· (Ä—* â‡’â–¡s*)

    _â‡â–¡ : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡ Ï„ âˆ£ ğ•) â†’ UExp
    (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ï„â‚ ]^ u)   â‡â–¡ = -Î» x âˆ¶ Ï„ âˆ™ (Ä› â‡â–¡s) ^ u
    (âŠ¢â¸¨Î» x âˆ¶ Ï„ âˆ™ Ä› â¸©[ Ï„'!â–¸ ]^ u)       â‡â–¡ = -Î» x âˆ¶ Ï„ âˆ™ (Ä› â‡â–¡s) ^ u
    (âŠ¢Î» x âˆ¶â¸¨ Ï„ â¸©âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ì¸Ï„â‚ ]^ u) â‡â–¡ = -Î» x âˆ¶ Ï„ âˆ™ (Ä› â‡â–¡s) ^ u
    âŠ¢â¸¨ Ä› â¸©[ Ï„~Ì¸Ï„' âˆ™ su ]                â‡â–¡ = Ä› â‡’â–¡
    âŠ¢âˆ™ Ä› [ Ï„~Ï„' âˆ™ su ]                 â‡â–¡ = Ä› â‡’â–¡

    _â‡â–¡s : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡s Ï„ âˆ£ ğ•) â†’ USubExp
    âŠ¢âˆ™ Ä› [ Ï„~Ï„' ] â‡â–¡s  = Ä›Â â‡’â–¡s
    âŠ¢â¸¨ Ä› â¸©[ Ï„~Ì¸Ï„' ] â‡â–¡s = Ä›Â â‡’â–¡s

  mutual
    âŠ¢â‡-âŠ¢â‡’ : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡ Ï„ âˆ£ ğ•) â†’ âˆƒ[ Ï„' ] âˆƒ[ ğ•' ] Î£[ Ä›' âˆˆ Î“ âŠ¢â‡’ Ï„' âˆ£ ğ•' ] Ä› â‡â–¡ â‰¡ Ä›' â‡’â–¡
    âŠ¢â‡-âŠ¢â‡’ (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ï„â‚ ]^ u)
      with âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä›' , eq âŸ© âŸ© âŸ© â† âŠ¢â‡s-âŠ¢â‡’s Ä› rewrite eq
         = âŸ¨ (Ï„ â–³) -â†’ Ï„' , âŸ¨ _ , âŸ¨ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä›' ^ u , refl âŸ© âŸ© âŸ©
    âŠ¢â‡-âŠ¢â‡’ (âŠ¢â¸¨Î» x âˆ¶ Ï„ âˆ™ Ä› â¸©[ Ï„'!â–¸ ]^ u)
      with âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä›' , eq âŸ© âŸ© âŸ© â† âŠ¢â‡s-âŠ¢â‡’s Ä› rewrite eq
         = âŸ¨ (Ï„ â–³) -â†’ Ï„' , âŸ¨ _ , âŸ¨ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä›' ^ u , refl âŸ© âŸ© âŸ©
    âŠ¢â‡-âŠ¢â‡’ (âŠ¢Î» x âˆ¶â¸¨ Ï„ â¸©âˆ™ Ä› [ Ï„â‚ƒâ–¸ âˆ™ Ï„~Ì¸Ï„â‚ ]^ u)
      with âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä›' , eq âŸ© âŸ© âŸ© â† âŠ¢â‡s-âŠ¢â‡’s Ä› rewrite eq
         = âŸ¨ (Ï„ â–³) -â†’ Ï„' , âŸ¨ _ , âŸ¨ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä›' ^ u , refl âŸ© âŸ© âŸ©
    âŠ¢â‡-âŠ¢â‡’ (âŠ¢â¸¨_â¸©[_âˆ™_] {Ï„' = Ï„'} Ä› Ï„~Ì¸Ï„' su) = âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä› , refl âŸ© âŸ© âŸ©
    âŠ¢â‡-âŠ¢â‡’ (âŠ¢âˆ™_[_âˆ™_]  {Ï„' = Ï„'} Ä› Ï„~Ï„' su) = âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä› , refl âŸ© âŸ© âŸ©

    âŠ¢â‡s-âŠ¢â‡’s : âˆ€ {Î“ Ï„ ğ•} â†’ (Ä› : Î“ âŠ¢â‡s Ï„ âˆ£ ğ•) â†’ âˆƒ[ Ï„' ] âˆƒ[ ğ•' ] Î£[ Ä›' âˆˆ Î“ âŠ¢â‡’s Ï„' âˆ£ ğ•' ] Ä› â‡â–¡s â‰¡ Ä›' â‡’â–¡s
    âŠ¢â‡s-âŠ¢â‡’s (âŠ¢âˆ™_[_]  {Ï„' = Ï„'} Ä› Ï„~Ï„') = âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä› , refl âŸ© âŸ© âŸ©
    âŠ¢â‡s-âŠ¢â‡’s (âŠ¢â¸¨_â¸©[_] {Ï„' = Ï„'} Ä› Ï„~Ï„') = âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä› , refl âŸ© âŸ© âŸ©

  private
    âŠ¢â‡’-âŠ¢â‡-subsume : âˆ€ {Î“ Ï„ ğ• Ï„'} â†’ (Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•) â†’ (su : MSubsumable Ä›) â†’ Î£[ Ä›' âˆˆ Î“ âŠ¢â‡ Ï„' âˆ£ ğ• ] Ä› â‡’â–¡ â‰¡ Ä›' â‡â–¡
    âŠ¢â‡’-âŠ¢â‡-subsume {Ï„ = Ï„} {Ï„' = Ï„'} Ä› su
      with Ï„' ~? Ï„ 
    ...  | yes Ï„'~Ï„ = âŸ¨ âŠ¢âˆ™ Ä› [ Ï„'~Ï„ âˆ™ su ] , refl âŸ©
    ...  | no  Ï„'~Ì¸Ï„ = âŸ¨ âŠ¢â¸¨ Ä› â¸©[ Ï„'~Ì¸Ï„ âˆ™ su ] , refl âŸ©

    âŠ¢â‡’s-âŠ¢â‡s-subsume : âˆ€ {Î“ Ï„ ğ• Ï„'} â†’ (Ä› : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•) â†’ Î£[ Ä›' âˆˆ Î“ âŠ¢â‡s Ï„' âˆ£ ğ• ] Ä› â‡’â–¡s â‰¡ Ä›' â‡â–¡s
    âŠ¢â‡’s-âŠ¢â‡s-subsume {Ï„ = Ï„} {Ï„' = Ï„'} Ä›
      with Ï„' ~? Ï„ 
    ...  | yes Ï„'~Ï„ = âŸ¨ âŠ¢âˆ™ Ä› [ Ï„'~Ï„ ] , refl âŸ©
    ...  | no  Ï„'~Ì¸Ï„ = âŸ¨ âŠ¢â¸¨ Ä› â¸©[ Ï„'~Ì¸Ï„ ] , refl âŸ©

  mutual
    âŠ¢â‡’-âŠ¢â‡ : âˆ€ {Î“ Ï„ ğ• Ï„'} â†’ (Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•) â†’ Î£[ Ä›' âˆˆ Î“ âŠ¢â‡ Ï„' âˆ£ ğ• ] Ä› â‡’â–¡ â‰¡ Ä›' â‡â–¡
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢ âˆ‹x ^ u)               = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuVar
    âŠ¢â‡’-âŠ¢â‡ {Ï„' = Ï„'} (âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› ^ u)
      with Ï„' â–¸-â†’?
    ...  | no  Ï„'!â–¸ with âŸ¨ Ä›' , eq âŸ© â† âŠ¢â‡’s-âŠ¢â‡s Ä› rewrite eq
         = âŸ¨ âŠ¢â¸¨Î» x âˆ¶ Ï„ âˆ™ Ä›' â¸©[ Ï„'!â–¸ ]^ u , refl âŸ©
    ...  | yes âŸ¨ Ï„â‚ , âŸ¨ Ï„â‚‚ , Ï„'â–¸ âŸ© âŸ© with (Ï„ â–³) ~? Ï„â‚
    ...    | yes Ï„~Ï„â‚ with âŸ¨ Ä›' , eq âŸ© â† âŠ¢â‡’s-âŠ¢â‡s Ä› rewrite eq
           = âŸ¨ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä›' [ Ï„'â–¸ âˆ™ Ï„~Ï„â‚ ]^ u , refl âŸ©
    ...    | no  Ï„~Ì¸Ï„â‚ with âŸ¨ Ä›' , eq âŸ© â† âŠ¢â‡’s-âŠ¢â‡s Ä› rewrite eq
           = âŸ¨ âŠ¢Î» x âˆ¶â¸¨ Ï„ â¸©âˆ™ Ä›' [ Ï„'â–¸ âˆ™ Ï„~Ì¸Ï„â‚ ]^ u , refl âŸ©
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸ ]^ u)    = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuAp1
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u) = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuAp2
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢â„• n ^ u)               = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuNum
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u)          = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuPlus
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢âŸ¦ âˆŒy âŸ§^ u)             = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuFree
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢â‹^ u)                  = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuMultiParent
    âŠ¢â‡’-âŠ¢â‡ Ä›@(âŠ¢â†»^ u)                  = âŠ¢â‡’-âŠ¢â‡-subsume Ä› MSuUnicycle

    âŠ¢â‡’s-âŠ¢â‡s : âˆ€ {Î“ Ï„ ğ• Ï„'} â†’ (Ä› : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•) â†’ Î£[ Ä›' âˆˆ Î“ âŠ¢â‡s Ï„' âˆ£ ğ• ] Ä› â‡’â–¡s â‰¡ Ä›' â‡â–¡s
    âŠ¢â‡’s-âŠ¢â‡s Ä› = âŠ¢â‡’s-âŠ¢â‡s-subsume Ä›
