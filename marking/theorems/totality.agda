open import marking.prelude
open import marking.definitions

module marking.theorems.totality where
  mutual
    -- TODO make context implicit
    â†¬â‡’-totality : (Î“ : Ctx)
                â†’ (e : UExp)
                â†’ Î£[ Ï„ âˆˆ Typ ] âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ âˆ£ ğ• ] (Î“ âŠ¢ e â†¬â‡’ Ä›)
    â†¬â‡’-totality Î“ (- x ^ u)
      with Î“ âˆ‹?? x
    ...  | yes (Z {Ï„ = Ï„})         = âŸ¨ Ï„       , âŸ¨ _ , âŸ¨ âŠ¢ Z ^ u           , MKSVar Z           âŸ© âŸ© âŸ©
    ...  | yes (S {Ï„ = Ï„} xâ‰¢x' âˆ‹x) = âŸ¨ Ï„       , âŸ¨ _ , âŸ¨ âŠ¢ (S xâ‰¢x' âˆ‹x) ^ u , MKSVar (S xâ‰¢x' âˆ‹x) âŸ© âŸ© âŸ©
    ...  | no  âˆŒx                  = âŸ¨ unknown , âŸ¨ _ , âŸ¨ âŠ¢âŸ¦ âˆŒx âŸ§^ u        , MKSFree âˆŒx         âŸ© âŸ© âŸ©
    â†¬â‡’-totality Î“ (-Î» x âˆ¶ Ï„ âˆ™ e ^ u)
      with âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä› , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’s-totality (Î“ , x âˆ¶ (Ï„ â–³)) e
         = âŸ¨ (Ï„ â–³) -â†’ Ï„' , âŸ¨ _ , âŸ¨ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä› ^ u , MKSLam eâ†¬â‡’Ä› âŸ© âŸ© âŸ©
    â†¬â‡’-totality Î“ (- eâ‚ âˆ™ eâ‚‚ ^ u)
      with â†¬â‡’s-totality Î“ eâ‚
    ...  | âŸ¨ Ï„ , âŸ¨ _ , âŸ¨ Ä›â‚ , eâ‚â†¬â‡’Ä›â‚ âŸ© âŸ© âŸ©
             with Ï„ â–¸-â†’?
    ...         | no Ï„!â–¸
                    with âŸ¨ _ , âŸ¨ Ä›â‚‚ , eâ‚‚â†¬â‡Ä›â‚‚ âŸ© âŸ© â† â†¬â‡s-totality Î“ unknown eâ‚‚
                       = âŸ¨ unknown , âŸ¨ _ , âŸ¨ âŠ¢â¸¨ Ä›â‚ â¸©âˆ™ Ä›â‚‚ [ Ï„!â–¸ ]^ u , MKSAp2 eâ‚â†¬â‡’Ä›â‚ Ï„!â–¸ eâ‚‚â†¬â‡Ä›â‚‚ âŸ© âŸ© âŸ©
    ...         | yes âŸ¨ Ï„â‚ , âŸ¨ Ï„â‚‚ , Ï„â–¸Ï„â‚-â†’Ï„â‚‚ âŸ© âŸ©
                    with âŸ¨ _ , âŸ¨ Ä›â‚‚ , eâ‚‚â†¬â‡Ä›â‚‚ âŸ© âŸ© â† â†¬â‡s-totality Î“ Ï„â‚ eâ‚‚
                       = âŸ¨ Ï„â‚‚ , âŸ¨ _ , âŸ¨ âŠ¢ Ä›â‚ âˆ™ Ä›â‚‚ [ Ï„â–¸Ï„â‚-â†’Ï„â‚‚ ]^ u , MKSAp1 eâ‚â†¬â‡’Ä›â‚ Ï„â–¸Ï„â‚-â†’Ï„â‚‚ eâ‚‚â†¬â‡Ä›â‚‚ âŸ© âŸ© âŸ©
    â†¬â‡’-totality Î“ (-â„• n ^ u) = âŸ¨ num , âŸ¨ _ , âŸ¨ âŠ¢â„• n ^ u , MKSNum âŸ© âŸ© âŸ©
    â†¬â‡’-totality Î“ (- eâ‚ + eâ‚‚ ^ u)
      with âŸ¨ _ , âŸ¨ Ä›â‚ , eâ‚â†¬â‡Ä›â‚ âŸ© âŸ© â† â†¬â‡s-totality Î“ num eâ‚
         | âŸ¨ _ , âŸ¨ Ä›â‚‚ , eâ‚‚â†¬â‡Ä›â‚‚ âŸ© âŸ© â† â†¬â‡s-totality Î“ num eâ‚‚
         = âŸ¨ num , âŸ¨ _ , âŸ¨ âŠ¢ Ä›â‚ + Ä›â‚‚ ^ u , MKSPlus eâ‚â†¬â‡Ä›â‚ eâ‚‚â†¬â‡Ä›â‚‚ âŸ© âŸ© âŸ©
    â†¬â‡’-totality Î“ (-â‹^ u) = âŸ¨ unknown , âŸ¨ _ , âŸ¨ âŠ¢â‹^ u , MKSMultiParent âŸ© âŸ© âŸ©
    â†¬â‡’-totality Î“ (-â†»^ u) = âŸ¨ unknown , âŸ¨ _ , âŸ¨ âŠ¢â†»^ u , MKSUnicycle âŸ© âŸ© âŸ©

    â†¬â‡’s-totality : (Î“ : Ctx)
                 â†’ (e : USubExp)
                 â†’ Î£[ Ï„ âˆˆ Typ ] âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’s Ï„ âˆ£ ğ• ] (Î“ âŠ¢s e â†¬â‡’ Ä›)
    â†¬â‡’s-totality Î“ (-â–¡^ w ^ p) = âŸ¨ unknown , âŸ¨ _ , âŸ¨ âŠ¢â–¡^ w ^ p , MKSubSHole âŸ© âŸ© âŸ©
    â†¬â‡’s-totality Î“ (-âˆ¶ âŸ¨ w , e âŸ©)
      with âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ Ä› , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’-totality Î“ e
         = âŸ¨ Ï„' , âŸ¨ _ , âŸ¨ âŠ¢âˆ¶ âŸ¨ w , Ä› âŸ© , MKSubSJust eâ†¬â‡’Ä› âŸ© âŸ© âŸ©
    â†¬â‡’s-totality Î“ (-â‹ Ä—*)
      with Ä—â†¬â‡’Ä›* â† â†¬â‡’s-totality* Î“ Ä—*
         = âŸ¨ unknown , âŸ¨ _ , âŸ¨ âŠ¢â‹ MKSubSConflictChildren Ä—â†¬â‡’Ä›* , MKSubSConflict Ä—â†¬â‡’Ä›* âŸ© âŸ© âŸ©

    â†¬â‡’s-totality* : (Î“ : Ctx)
                  â†’ (Ä—* : List USubExp')
                  â†’ All (Î» (âŸ¨ _ , e âŸ©) â†’ âˆƒ[ Ï„ ] âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡’ Ï„ âˆ£ ğ• ] Î“ âŠ¢ e â†¬â‡’ Ä›) Ä—*
    â†¬â‡’s-totality* Î“ []               = []
    â†¬â‡’s-totality* Î“ (âŸ¨ w , e âŸ© âˆ· Ä—*) = â†¬â‡’-totality Î“ e âˆ· â†¬â‡’s-totality* Î“ Ä—*

    â†¬â‡-subsume : âˆ€ {Î“ e Ï„ ğ•}
               â†’ (Ä› : Î“ âŠ¢â‡’ Ï„ âˆ£ ğ•)
               â†’ (Ï„' : Typ)
               â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢ e â†¬â‡’ Ä›)
               â†’ (s : USubsumable e)
               â†’  âˆƒ[ ğ•' ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡ Ï„' âˆ£ ğ•' ] (Î“ âŠ¢ e â†¬â‡ Ä›)
    â†¬â‡-subsume {Ï„ = Ï„} Ä› Ï„' eâ†¬â‡’Ä› s with Ï„' ~? Ï„
    ...   | yes Ï„'~Ï„ = âŸ¨ _ , âŸ¨ âŠ¢âˆ™ Ä›  [ Ï„'~Ï„ âˆ™ USuâ†’MSu s eâ†¬â‡’Ä› ] , MKASubsume eâ†¬â‡’Ä› Ï„'~Ï„ s âŸ© âŸ©
    ...   | no  Ï„'~Ì¸Ï„ = âŸ¨ _ , âŸ¨ âŠ¢â¸¨ Ä› â¸©[ Ï„'~Ì¸Ï„ âˆ™ USuâ†’MSu s eâ†¬â‡’Ä› ] , MKAInconsistentTypes eâ†¬â‡’Ä› Ï„'~Ì¸Ï„ s âŸ© âŸ©

    â†¬â‡s-subsume : âˆ€ {Î“ e Ï„ ğ•}
                â†’ (Ä› : Î“ âŠ¢â‡’s Ï„ âˆ£ ğ•)
                â†’ (Ï„' : Typ)
                â†’ (eâ†¬â‡’Ä› : Î“ âŠ¢s e â†¬â‡’ Ä›)
                â†’ âˆƒ[ ğ•' ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡s Ï„' âˆ£ ğ•' ] (Î“ âŠ¢s e â†¬â‡ Ä›)
    â†¬â‡s-subsume {Ï„ = Ï„} Ä› Ï„' eâ†¬â‡’Ä›  with Ï„' ~? Ï„
    ...   | yes Ï„'~Ï„ = âŸ¨ _ , âŸ¨ âŠ¢âˆ™ Ä›  [ Ï„'~Ï„ ] , MKSubASubsume eâ†¬â‡’Ä› Ï„'~Ï„ âŸ© âŸ©
    ...   | no  Ï„'~Ì¸Ï„ = âŸ¨ _ , âŸ¨ âŠ¢â¸¨ Ä› â¸©[ Ï„'~Ì¸Ï„ ] , MKSubAInconsistentTypes eâ†¬â‡’Ä› Ï„'~Ì¸Ï„ âŸ© âŸ©

    â†¬â‡-totality : (Î“ : Ctx)
                â†’ (Ï„' : Typ)
                â†’ (e : UExp)
                â†’ âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡ Ï„' âˆ£ ğ• ] (Î“ âŠ¢ e â†¬â‡ Ä›)
    â†¬â‡-totality Î“ Ï„' e@(- x ^ u)
      with â†¬â‡’-totality Î“ e
    ...  | âŸ¨ .unknown , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢âŸ¦ âˆŒx âŸ§^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuVar
    ...  | âŸ¨ Ï„        , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢ âˆ‹x ^ u)   , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuVar
    â†¬â‡-totality Î“ Ï„' e@(-Î» x âˆ¶ Ï„ âˆ™ e' ^ u)
      with Ï„' â–¸-â†’?
    ...  | yes âŸ¨ Ï„â‚ , âŸ¨ Ï„â‚‚ , Ï„'â–¸ âŸ© âŸ©
             with (Ï„ â–³) ~? Ï„â‚
    ...         | yes Ï„~Ï„â‚
                    with âŸ¨ _ , âŸ¨ Ä›' , e'â†¬â‡Ä›' âŸ© âŸ© â† â†¬â‡s-totality (Î“ , x âˆ¶ (Ï„ â–³)) Ï„â‚‚ e'
                       = âŸ¨ _ , âŸ¨ âŠ¢Î» x âˆ¶ Ï„ âˆ™ Ä›' [ Ï„'â–¸ âˆ™ Ï„~Ï„â‚ ]^ u , MKALam1 Ï„'â–¸ Ï„~Ï„â‚ e'â†¬â‡Ä›' âŸ© âŸ©
    ...         | no  Ï„~Ì¸Ï„â‚
                    with âŸ¨ _ , âŸ¨ Ä›' , e'â†¬â‡Ä›' âŸ© âŸ© â† â†¬â‡s-totality (Î“ , x âˆ¶ (Ï„ â–³)) Ï„â‚‚ e'
                       = âŸ¨ _ , âŸ¨ âŠ¢Î» x âˆ¶â¸¨ Ï„ â¸©âˆ™ Ä›' [ Ï„'â–¸ âˆ™ Ï„~Ì¸Ï„â‚ ]^ u , MKALam3 Ï„'â–¸ Ï„~Ì¸Ï„â‚ e'â†¬â‡Ä›' âŸ© âŸ©
    â†¬â‡-totality Î“ Ï„' e@(-Î» x âˆ¶ Ï„ âˆ™ e' ^ u)
         | no Ï„'!â–¸
             with âŸ¨ _ , âŸ¨ Ä›' , e'â†¬â‡Ä›' âŸ© âŸ© â† â†¬â‡s-totality (Î“ , x âˆ¶ (Ï„ â–³)) unknown e'
                = âŸ¨ _ , âŸ¨ âŠ¢â¸¨Î» x âˆ¶ Ï„ âˆ™ Ä›' â¸©[ Ï„'!â–¸ ]^ u , MKALam2 Ï„'!â–¸ e'â†¬â‡Ä›' âŸ© âŸ©
    â†¬â‡-totality Î“ Ï„' e@(- _ âˆ™ _ ^ u)
      with â†¬â‡’-totality Î“ e
    ...  | âŸ¨ .unknown , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢â¸¨ _ â¸©âˆ™ _ [ _ ]^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuAp
    ...  | âŸ¨ _        , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢  _  âˆ™ _ [ _ ]^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuAp
    â†¬â‡-totality Î“ Ï„' e@(-â„• _ ^ u)
      with âŸ¨ _ , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢â„• _ ^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’-totality Î“ e
         = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuNum
    â†¬â‡-totality Î“ Ï„' e@(- _ + _ ^ u)
      with âŸ¨ _ , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢ _ + _ ^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’-totality Î“ e
         = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuPlus
    â†¬â‡-totality Î“ Ï„' e@(-â‹^ u)
      with âŸ¨ _ , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢â‹^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’-totality Î“ e
         = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuMultiParent
    â†¬â‡-totality Î“ Ï„' e@(-â†»^ u)
      with âŸ¨ _ , âŸ¨ _ , âŸ¨ Ä›@(âŠ¢â†»^ u) , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’-totality Î“ e
         = â†¬â‡-subsume Ä› Ï„' eâ†¬â‡’Ä› USuUnicycle

    â†¬â‡s-totality : (Î“ : Ctx)
                 â†’ (Ï„' : Typ)
                 â†’ (e : USubExp)
                 â†’ âˆƒ[ ğ• ] Î£[ Ä› âˆˆ Î“ âŠ¢â‡s Ï„' âˆ£ ğ• ] (Î“ âŠ¢s e â†¬â‡ Ä›)
    â†¬â‡s-totality Î“ Ï„' e
      with âŸ¨ _ , âŸ¨ _ , âŸ¨ Ä› , eâ†¬â‡’Ä› âŸ© âŸ© âŸ© â† â†¬â‡’s-totality Î“ e
         = â†¬â‡s-subsume Ä› Ï„' eâ†¬â‡’Ä›
